import{d as $,u as W,r as v,c as _,o as z,a as A,b as a,e as n,t as r,f as E,F as p,g as f,h as c,n as I}from"./index-TzivwsyV.js";import{g as J}from"./schools-DEBpxMRk.js";import{g as O}from"./classes-B9YAiphQ.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";const q={class:"screen-container"},G={class:"screen-header"},H={class:"title"},K={class:"timestamp"},P={class:"clock"},Q={key:0,class:"update"},X={key:0,class:"screen-loading"},Y={key:1,class:"screen-table"},Z={class:"table-header"},ee={class:"grade-cell"},se={class:"screen-legend"},oe={class:"legend-text"},te=$({__name:"ScreenDisplayView",setup(le){const B=W(),u=Number(B.params.schoolId),w=v(!0),d=v([]),b=v(""),g=v(null);let l=null;const y={0:{text:"已放学",color:"#0066FF"},1:{text:"上课中",color:"#FF6600"},2:{text:"放学中",color:"#00C853"}},N=v(new Date),M=_(()=>N.value.toLocaleString()),x=_(()=>g.value?g.value.toLocaleString():"");let h=null,i=null,k=0,C=!0;const L=_(()=>{const s=new Set;return d.value.forEach(t=>s.add(Number(t.grade))),Array.from(s).sort((t,e)=>t-e)}),D=_(()=>d.value.reduce((s,t)=>Math.max(s,Number(t.class)),0)),R=s=>y[s]?.text??"未知",T=s=>y[s]?.color??"#999999",U=_(()=>L.value.map(s=>{const t={grade:s,classes:[]};for(let e=1;e<=D.value;e++){const o=d.value.find(m=>Number(m.grade)===s&&Number(m.class)===e);o?t.classes.push(o):t.classes.push({id:-1,grade:s,class:e,status:-1,school_id:u,school_name:b.value,name:"",teacher_infos:[]})}return t})),S=()=>{if(!C||i)return;const s=Math.min(1e3*Math.pow(2,k),5e3);console.log("scheduleReconnect",s),i=window.setTimeout(()=>{i=null,k++,F()},s)},F=()=>{try{const t=`wss://school.bytefuse.cn//ws/school/${u}`;console.log("connectWebSocket",t),l&&(l.onopen=null,l.onmessage=null,l.onerror=null,l.onclose=null,l.close(),l=null),l=new WebSocket(t),l.onopen=()=>{console.log("screen socket ws connected"),k=0},l.onmessage=e=>{try{console.log("socket onmessage",e.data);const o=JSON.parse(e.data);o&&(d.value=d.value.map(m=>m.id===o.class_id?{...m,status:Number(o.new_status)}:m),g.value=new Date)}catch(o){console.warn("Invalid ws payload",o)}},l.onerror=e=>{console.error("screen socket ws error",e),S()},l.onclose=()=>{console.log("screen socket ws closed"),S()}}catch(s){console.error("Failed to open socket websocket",s),S()}},V=async()=>{w.value=!0;try{const s=await J(u);b.value=s.name;const t=await O(u);console.log("get data",t);const e=t.map(o=>({...o,id:Number(o.id??o.class_id??-1),grade:Number(o.grade??0),class:Number(o.class??o.class_num??0),status:Number(o.status??0)}));d.value=e,g.value=new Date}catch(s){console.error("Failed to load classes",s)}finally{w.value=!1}};return z(async()=>{if(!u){console.error("Invalid school id in route");return}await V(),F(),console.log("onMounted",u),h=window.setInterval(()=>{N.value=new Date},1e3)}),A(()=>{console.log("onBeforeUnmount"),C=!1,l&&(l.close(),l=null),i&&(clearTimeout(i),i=null),h&&(clearInterval(h),h=null)}),(s,t)=>(c(),a("div",q,[n("div",G,[n("div",H,r(b.value),1),n("div",K,[n("div",P,r(M.value),1),x.value?(c(),a("div",Q,"上次更新："+r(x.value),1)):E("",!0)])]),w.value?(c(),a("div",X,"加载中...")):(c(),a("div",Y,[n("div",Z,[t[0]||(t[0]=n("div",{class:"grade-cell"},null,-1)),(c(!0),a(p,null,f(D.value,e=>(c(),a("div",{class:"class-cell",key:e},r(e)+"班",1))),128))]),(c(!0),a(p,null,f(U.value,e=>(c(),a("div",{class:"table-row",key:e.grade},[n("div",ee,r(e.grade)+"年级",1),(c(!0),a(p,null,f(e.classes,o=>(c(),a("div",{class:"status-cell",key:`${e.grade}-${o.class}`,style:I({color:T(o.status)})},r(R(o.status)),5))),128))]))),128))])),n("div",se,[(c(),a(p,null,f(y,(e,o)=>n("div",{class:"legend-item",key:o},[n("span",{class:"legend-color",style:I({backgroundColor:e.color})},null,4),n("span",oe,r(e.text),1)])),64))])]))}}),ue=j(te,[["__scopeId","data-v-85aaf5c5"]]);export{ue as default};
